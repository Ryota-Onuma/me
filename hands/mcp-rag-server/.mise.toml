[tools]
[tasks."project:show"]
description = "ç¾åœ¨ã®PROJECTã‚’è¡¨ç¤º"
run = '''
bash -c 'set -e; if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi; echo PROJECT=${PROJECT:-default}'
'''

[tasks."project:init"]
description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆè¨­å®šJSON+ã‚¹ã‚­ãƒ¼ãƒä½œæˆï¼‰"
run = '''
bash -lc '
set -e
NAME_ARG=${NAME:+--name "$NAME"}
# NAME ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã° /app/data/source/<NAME> ã‚’æ—¢å®šã«ã€æœªæŒ‡å®šãªã‚‰CLIå´ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«ä»»ã›ã‚‹
if [ -n "$NAME" ]; then
  SRC_ARG="--source-dir /app/data/source/$NAME"
else
  SRC_ARG=""
fi
PROC_ARG="--processed-dir /app/data/processed"

if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
if [ -r /dev/tty ]; then
  docker compose exec mcp-server \
    uv run python -m src.cli project init $NAME_ARG $SRC_ARG $PROC_ARG < /dev/tty
else
  docker compose exec -T mcp-server \
    uv run python -m src.cli project init $NAME_ARG $SRC_ARG $PROC_ARG
fi
'
'''

[tasks."project:list"]
description = "å®šç¾©æ¸ˆã¿ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§"
run = '''
bash -lc '
set -e
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli project list
'
'''

[tasks."project:choose"]
description = "å¯¾è©±é¸æŠã—ã¦åå‰ã‚’è¿”ã™ï¼ˆä»–ã‚¿ã‚¹ã‚¯ç”¨ï¼‰"
run = '''
bash -lc '
set -e
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
if [ -r /dev/tty ]; then
  docker compose exec mcp-server \
    uv run python -m src.cli project choose < /dev/tty
else
  # TTYãŒãªã„å ´åˆã‚‚STDINã¯è»¢é€ã—ã¦å¯¾è©±å¯èƒ½ã«ã™ã‚‹
  docker compose exec -T mcp-server \
    uv run python -m src.cli project choose
fi
'
'''

[tasks."project:profiles"]
description = "MCPæ¥ç¶šç”¨ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ï¼ˆJSONå‡ºåŠ›ï¼‰"
run = '''
bash -lc '
set -e
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli project profiles
'
'''

[tasks."project:delete"]
description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå‰Šé™¤ï¼ˆè¨­å®š/ã‚¹ã‚­ãƒ¼ãƒ/ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰\n  ä½¿ç”¨æ–¹æ³•: NAME=ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå YES=1 mise run project:delete\n  ã‚ªãƒ—ã‚·ãƒ§ãƒ³: DROP_DB=1, DELETE_PROCESSED=1, DELETE_SOURCE=1"
run = '''
bash -lc '
set -e
NAME_ARG=${NAME:+--name "$NAME"}
FLAGS=
[ -n "$DROP_DB" ] && FLAGS="$FLAGS --drop-db"
[ -n "$DELETE_PROCESSED" ] && FLAGS="$FLAGS --delete-processed"
[ -n "$DELETE_SOURCE" ] && FLAGS="$FLAGS --delete-source"
[ -n "$YES" ] && FLAGS="$FLAGS --yes"
# éå¯¾è©±çš„å®Ÿè¡Œã®ãƒã‚§ãƒƒã‚¯
if [ -z "$NAME" ] && [ ! -t 0 ]; then
  echo "éå¯¾è©±çš„å®Ÿè¡Œæ™‚ã¯ NAME ç’°å¢ƒå¤‰æ•°ãŒå¿…è¦ã§ã™ã€‚" >&2
  echo "ä½¿ç”¨ä¾‹: NAME=ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå YES=1 mise run project:delete" >&2
  exit 1
fi
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
if [ -r /dev/tty ]; then
  docker compose exec mcp-server \
    uv run python -m src.cli project delete $NAME_ARG $FLAGS < /dev/tty
else
  docker compose exec -T mcp-server \
    uv run python -m src.cli project delete $NAME_ARG $FLAGS
fi
'
'''

[tasks."project:select"]
description = "å¯¾è©±å¼ã«PROJECTã‚’è¨­å®šï¼ˆ.envã‚’æ›¸ãæ›ãˆï¼‰"
run = '''
bash -lc '
set -e
# å¯¾è©±é¸æŠã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å–å¾—
if [ -r /dev/tty ]; then
  P=$(mise run -q project:choose < /dev/tty 2>/dev/tty)
else
  P=$(mise run -q project:choose)
fi
# .env ã‚’å®‰å…¨ã«æ›´æ–°
touch .env
if grep -q "^PROJECT=" .env; then
  sed -i.bak "/^PROJECT=/d" .env && rm -f .env.bak
fi
echo "PROJECT=${P}" >> .env
echo "PROJECTã‚’ ${P} ã«è¨­å®šã—ã¾ã—ãŸ (.env)"
'
'''

[tasks."rag:index"]
description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ– (Dockerå„ªå…ˆ)"
run = '''
bash -c '
set -e
# .envã®èª­ã¿è¾¼ã¿
if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT=${PROJECT:-alpha}
SIZE=${SIZE:-500}
OVERLAP=${OVERLAP:-100}
# å¢—åˆ†ãƒ•ãƒ©ã‚°
INC_FLAG=
case "${INCREMENTAL:-false}" in true|1|yes|on) INC_FLAG="-i" ;; esac
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã®sourceãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆdata/source/<project>) ã‚’æ—¢å®šã«ã™ã‚‹
DIR=${DIR:-/app/data/source/${PROJECT}}
echo "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã‚’é–‹å§‹ã—ã¾ã™..."
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli --project "$PROJECT" index -d "$DIR" -s "$SIZE" -o "$OVERLAP" $INC_FLAG
'
'''

[tasks."rag:index:select"]
description = "å¯¾è©±é¸æŠã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å®šâ†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–"
run = '''
bash -lc '
set -e
P=$(mise run -q project:choose < /dev/tty 2>/dev/tty)
SIZE=${SIZE:-500}
OVERLAP=${OVERLAP:-100}
# é¸æŠã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®sourceãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªï¼ˆdata/source/<project>ï¼‰ã‚’æ—¢å®šã«ã™ã‚‹
DIR=${DIR:-/app/data/source/${P}}
echo "ğŸ“ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $P ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–ã‚’é–‹å§‹ã—ã¾ã™..."
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli --project "$P" index -d "$DIR" -s "$SIZE" -o "$OVERLAP" ${INCREMENTAL:+-i}
'
'''

[tasks."rag:count"]
description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä»¶æ•°ã‚’è¡¨ç¤º (Dockerå„ªå…ˆ)"
run = '''
bash -c '
set -e
if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT=${PROJECT:-alpha}
echo "ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT ã®ä»¶æ•°ã‚’å–å¾—ã—ã¾ã™..."
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli --project "$PROJECT" count
'
'''

[tasks."rag:clear"]
description = "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ (Dockerå„ªå…ˆ)"
run = '''
bash -c '
set -e
if [ -f .env ]; then export $(grep -v '^#' .env | xargs); fi
PROJECT=${PROJECT:-alpha}
echo "ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™..."
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli --project "$PROJECT" clear
'
'''

[tasks."rag:count:select"]
description = "å¯¾è©±é¸æŠã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å®šâ†’ä»¶æ•°å–å¾—"
run = '''
bash -lc '
set -e
P=$(mise run -q project:choose < /dev/tty 2>/dev/tty)
echo "ğŸ“Š ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $P ã®ä»¶æ•°ã‚’å–å¾—ã—ã¾ã™..."
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli --project "$P" count
'
'''

[tasks."rag:clear:select"]
description = "å¯¾è©±é¸æŠã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å®šâ†’ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å‰Šé™¤"
run = '''
bash -lc '
set -e
P=$(mise run -q project:choose < /dev/tty 2>/dev/tty)
echo "ğŸ—‘ï¸ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $P ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™..."
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
docker compose exec -T mcp-server \
  uv run python -m src.cli --project "$P" clear
'
'''

[tasks."mcp:start"]
description = "MCPã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆPROJECTã‚’ENVã¾ãŸã¯å¼•æ•°ã§æŒ‡å®šï¼‰"
run = '''
bash -lc '
set -e
NAME=${NAME:-mcp-rag-server}
DESC=${DESC:-MCP RAG Server}
PROJECT=${PROJECT:-alpha}
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
echo "ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $PROJECT ã§MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™..."
if [ -r /dev/tty ]; then
  docker compose exec mcp-server uv run python -m src.main --name "$NAME" --description "$DESC" --project "$PROJECT" < /dev/tty
else
  docker compose exec -T mcp-server uv run python -m src.main --name "$NAME" --description "$DESC" --project "$PROJECT"
fi
'
'''

[tasks."mcp:start:select"]
description = "å¯¾è©±é¸æŠã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å®šâ†’MCPèµ·å‹•"
run = '''
bash -lc '
set -e
P=$(mise run -q project:choose)
NAME=${NAME:-mcp-rag-server}
DESC=${DESC:-MCP RAG Server}
if [ -z "$(docker compose ps -q mcp-server 2>/dev/null)" ]; then
  echo "mcp-server ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚docker compose up -d ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" >&2
  exit 1
fi
echo "ğŸš€ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: $P ã§MCPã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¾ã™..."
if [ -r /dev/tty ]; then
  docker compose exec mcp-server uv run python -m src.main --name "$NAME" --description "$DESC" --project "$P" < /dev/tty
else
  docker compose exec -T mcp-server uv run python -m src.main --name "$NAME" --description "$DESC" --project "$P"
fi
'
'''
